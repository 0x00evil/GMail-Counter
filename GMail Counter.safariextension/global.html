<!DOCTYPE HTML>
<script>
var newTab;
var eventVar;
var user_uid;
var version;

function performCommand(event) {
    if (event.command === "button") {
    	if (safari.extension.settings.getItem("tab")) {
			if (typeof(newTab) == 'undefined' || typeof(newTab.url) == 'undefined') {
				newTab = safari.application.activeBrowserWindow.openTab();
			}
			newTab.url = 'https://mail.google.com/mail/';
			newTab.activate();
		} else {
			safari.application.activeBrowserWindow.activeTab.url = 'https://mail.google.com/mail/';
		}
    }

}

function validateCommand(event) {

    if (event.command === "button") {

        // Disable the button if there is no URL loaded in the tab.
		eventVar=event;
		event.target.toolTip = "GMail Counter - Loading...";
        xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
        	if (xhr.readyState==4 && xhr.status==200 && xhr.responseXML) {
				xmlData = xhr.responseXML;
				fullCountSet = xmlData.evaluate("/gmail:feed/gmail:fullcount", xmlData, gmailNSResolver, XPathResult.ANY_TYPE, null);
				unread = fullCountSet.iterateNext();
				if(unread.textContent != 0) {
					message = (unread.textContent==1)?"message":"messages";
					event.target.toolTip = "GMail Counter - "+unread.textContent+" new "+message;
					event.target.badge = unread.textContent;
				} else {
					event.target.toolTip = "GMail Counter - No new messages";
					event.target.badge = unread.textContent;
					//event.target.image = safari.extension.baseURI + "status-unread.png";
				}
			}
		}
		xhr.open("GET","https://mail.google.com/mail/feed/atom",true);
		xhr.send();
    }
}

function gmailNSResolver(prefix) {
  if(prefix == 'gmail') {
	return 'http://purl.org/atom/ns#';
  }
}

/*function getStats() {
	user_uid = safari.extension.settings.getItem("user_uid");
	version = safari.extension.settings.getItem("version");
	stats = safari.extension.settings.getItem("stats");
	
	v = user_uid.substring(14,16);
	v1 = v.substring(0,1);
	v2 = v.substring(1,2);
	uuid_ver = (v2=="A")?v1:v;
	
	if (stats == "not set") {
		stats = confirm("Do you want to send usage statistics (version in use , preferred settings, etc...) to developer?\nNO PERSONAL INFORMATION, SUCH MAIL COUNT OR ACCOUNT DATAS, WILL BE SENT\nNO DATA WILL BE SENT TO ANY THIRD PARTY");
		safari.extension.settings.stats=stats;
	}
	
	if (user_uid == "nullo" && stats) {
		xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
        	if (xhr.readyState==4 && xhr.status==200 && xhr.responseText) {
        		safari.extension.settings.user_uid = xhr.responseText;
        		user_uid = xhr.responseText;
        	}
        }
        xhr.open("GET","http://elix14.altervista.org/GMailCounter/stats.php?v="+version,true);
		xhr.send();
		alert("New<");
	} else if (uuid_ver != version && stats) {
		xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
        	if (xhr.readyState==4 && xhr.status==200 && xhr.responseText) {
        		safari.extension.settings.user_uid = xhr.responseText;
        		user_uid = xhr.responseText;
        	}
        }
        alert("Update");
        xhr.open("GET","http://elix14.altervista.org/GMailCounter/stats.php?u="+user_uid+"&v="+version,true);
		xhr.send();
	} else if ( stats ) {
		xhr = new XMLHttpRequest();
        xhr.open("GET","http://elix14.altervista.org/GMailCounter/stats.php?u="+user_uid,true);
		xhr.send();
		alert("Launch");
	}
}

getStats();*/
safari.application.addEventListener("validate", validateCommand, false);
safari.application.addEventListener("command", performCommand, false);
</script>
